## 第1章 计算机系统概述

### 1.1 操作系统基本概念

#### 基本概念

操作系统作为用户与计算机硬件系统之间的接口：

（1）命令接口：联机命令接口（联机控制方式）、脱机命令接口（脱机控制方式）

联机命令接口：交互式命令接口，适用于**分时或实时操作系统**。由一组键盘操作命令组成。用户通过控制台或终端输入操作命令，由命令解释程序解释并执行。

脱机命令接口：批处理命令接口，适用于**批处理系统**，由一组作业控制命令组成。

（2）程序接口：由一组系统调用（也称广义指令）组成。在程序中使用来请求操作系统提供服务，如**各种外部设备、申请分配和回收内存**等。

#### 例题

10. 调用是由操作系统提供给用户的，它（~~D~~）B

A、直接通过键盘交互方式使用				B、只能通过用户程序间接使用

C、是命令接口中的命令				D、与系统的命令一样

`系统调用是操作系统为应用程序使用内核功能所提供的接口`

16. 操作系统与用户通信接口通常不包括（~~A~~）D

A、shell				B、命令解释器				C、广义指令				D、缓存管理指令

`命令解释器属于命令接口，shell是命令解析器，它也属于命令接口。缓存全部由操作系统管理，对用户透明，操作系统不提供管理系统缓存的系统调用。`

17. 下列选项中，不属于多道程序设计的基本特征是（C）

A、制约性				B、间断性				C、顺序性				D、共享性

`引入多道程序设计后，程序的执行就失去了封闭性和顺序性。程序的执行是断续的。顺序性是单道程序设计的基本特征。`

### 1.2 操作系统的发展与分类

#### 基本概念

单道批处理系统：自动性、**顺序性**、单道性

多道批处理系统：多道、宏观上并行、微观上串行

分时操作系统：同时性、交互性、独立性、及时性

实时操作系统：及时性、可靠性，诞生于需要系统能对外部信息在规定时间（比时间片时间还短）内做出处理。

网络操作系统：网络中各种资源的共享、各台计算机之间的通信

分布式计算机系统：分布性、并行性，与网络操作系统本质不同是，分布式操作系统中的若干计算机相互协同完成同一任务。

#### 例题

1. 提高单机资源利用率的关键技术是（D）

A、脱机技术				B、虚拟技术				C、交换技术				D、多道程序设计技术

`脱机技术用于解决独占设备问题。虚拟技术与交换技术以多道程序设计技术为前提。多道程序设计技术由于同时在主存中运行多个程序，在一个程序等待时，就可以去执行其他程序，因此提高了系统资源的利用率。`

16. 【2018】下列关于多任务操作系统的叙述中，正确的是（~~D~~）C

I、具有并发和并行的特点

II、需要实现对共享资源的保护

III、需要运行在多CPU的硬件平台上

A、仅I				B、仅II				C、仅I、II				D、I、II、III

`III、错误，现代操作系统都是多任务的（主要特点是并发和并行），并不一定需要运行在多CPU的硬件上，单个CPU也可满足要求。`

### 1.3 操作系统的运行环境

#### 基本概念

核心态指令包括**系统调用类指令**和一些针对**时钟**、**中断**和**原语**的操作指令。

中断也称外中断，指来自CPU执行指令以外的事件的发生，如设备发出的**I/O结束中断**，**时钟中断**。

异常也称内中断、例外、陷入，指源自CPU执行指令内部的事件，如程序的**非法操作码**、**地址越界**、**算术溢出**、**虚存系统缺页**及**陷入指令**（又称访管指令，可以申请进入核心态）等。

中断处理过程：

（1）关中断；（2）保存断点（即程序计数器PC）；（3）中断服务程序寻址；

1~3步由**硬件自动**（中断隐指令）完成

（4）保存现场和屏蔽字（程序状态字寄存器PSWR、某些通用寄存器）；

（5）开中断；（6）执行中断服务程序；（7）关中断；（8）恢复现场和屏蔽字；（9）开中断、中断返回。

4~9步由中断服务程序完成

从核心态转向用户态由一条指令实现，这条指令也是特权命令，一般是中断返回指令。若程序的运行由用户态转到核心态，则会用到访管指令，访管指令是在用户态使用的，所以它不可能是特权指令。

#### 例题

1. 在通用操作系统管理下的计算机上运行程序，需要向操作系统预订运行时间

`通用操作系统使用时间片轮转调度算法，用户运行程序并不需要预先预订运行时间，因此错误。`

2. 下列说法中国，正确的是（~~B~~）C

I、批处理的主要缺点是需要大量内存

II、当计算机提供了核心态和用户态时，输入/输出指令必须在核心态下执行

III、操作系统中采用多道程序设计技术的最主要原因是提高CPU和外部设备的可靠性

IV、操作系统中，通道技术是一种硬件技术

A、I、II				B、I、III				C、II、IV				D、II、III、IV

`I、错误，批处理的主缺点是缺少交互性。II、正确。III、错误，多道性是为了提高系统利用率和吞吐量而提出的。IV、正确，I/O通道实际上是一种特殊的处理器，它具有执行I/O指令的能力，并通过执行通道程序来控制I/O操作。`

5. 用户程序在用户态下要使用特权指令引起的中断属于（~~B~~）D

A、硬件故障中断				B、程序中断				C、外部中断				D、访管中断

`因操作系统不允许用户直接执行某些“危险性高”的指令，因此用户态运行这些指令的结果会转成操作系统的核心态去运行。这个过程就是访管中断。`

9. 计算机区分核心态和用户态指令后，从核心态到用户态的转换是由操作系统程序执行后完成的，而用户态到核心态的转换则是由（~~C~~）A完成的。

A、硬件				B、核心态程序				C、用户程序				D、中断处理程序

`计算机通过硬件中断机制完成由用户态到核心态的转换。核心态程序和中断处理程序都在核心态执行。若由用户程序将操作系统由用户态转换到核心态，则用户程序就可使用核心态指令，这就会威胁到计算机的安全，所以C错误。`

`计算机通过硬件完成操作系统由用户态到核心态的转换，这是通过中断机制来实现的。发生中断事件时（有可能是用户程序发出的系统调用），触发中断，硬件中断机制将计算机状态置为核心态。`

11. 【2012】不可能在用户态发生的事件是（C）

A、系统调用				B、外部中断				C、进程切换				D、缺页

`在用户态“发生”与“执行”区分。A、系统调用发生在用户态，执行在核心态。B、外部中断发生在用户态，完成在核心态。C、进程切换属于系统执行过程中的事件，只能发生在核心态。D、用户态发生缺页中断，进入核心态执行处理程序。`

20. 【2012】中断处理和子程序调用都需要压栈以保护现场，中断处理一定会保存而子程序调用不需要保存其内容的是（~~A~~）B

A、程序计数器				B、程序状态字寄存器

C、通用数据寄存器			D、通用地址寄存器

`子程序调用只需保存程序断点（PC）；中断调用子程序保存断点（PC）、程序状态字寄存器（PSW）`

23. 【2016】错误的是（~~D~~）A

A、“访存时缺页”属于中断				B、“整数除以0”属于异常

C、“DMA传送结束”属于中断				D、“存储保护错”属于异常



24. 【2015】处理外部中断时，应该由操作系统保存的是（~~A~~）B

A、程序计数器（PC）的内容				B、通用寄存器的内容

C、快表（TLB）中的内容				D、Cache中的内容

`外部中断处理过程，PC值由中断隐指令自动保存，而通用寄存器内容由操作系统保存。`

26. 【2017】执行系统调用的过程包括如下主要操作：

（1）返回用户态				（2）执行陷入（trap）指令

（3）传递系统调用参数				（4）执行相应的服务程序

正确的执行顺序是（~~B~~）C

A、2-3-1-4				B、2-4-3-1				C、3-2-4-1				D、3-4-2-1

`执行系统调用的过程如下：正在运行的进程先传递系统调用参数，然后由陷入（trap）指令负责将用户态转换为内核态，并将返回地址压入堆栈以备后用，接下来CPU执行相应的内核态服务程序，最后返回用户态。`

28、【2019】下列关于系统调用的叙述中，正确的是（~~D~~）C

I、在执行系统调用服务程序的过程中，CPU处于内核态

II、操作系统通过提供系统调用避免用户程序直接访问外设

III、不同的操作系统为应用程序提供了统一的系统调用接口

IV、系统调用是操作系统给内核为应用程序提供服务的接口

A、仅I、IV				B、仅II、III				C、仅I、II、IV				D、仅I、III、IV

`III、操作系统不同，底层逻辑、实现方式均不同，为应用程序提供的系统调用接口也不同。`

29. 【2020】下列与中断相关的操作中，由操作系统完成的是（~~A~~）D

I、保存被中断程序的中断点				II、提供中断服务

III、初始化中断向量表				IV、保存中断屏蔽字

A、仅I、II				B、仅I、II、IV				C、仅III、IV				D、仅II、III、IV

`中断点由硬件自动保存；硬件找到中断信号对应的中断向量，但是中断向量表由操作系统初始化；中断服务程序属于操作系统内核。`

### 1.4 操作系统的体系结构

#### 基本概念

**大内核和微内核：**

操作系统内核被分成基本进程管理、虚存、I/O与设备管理、IPC、文件系统

微内核结构的最大问题是性能问题，因为需要频繁在核心态和用户态之间进行切换。

### 1.5 疑难点

CPU在核心态下可以执行指令系统的全集。

用户程序利用访管指令产生访管中断，进入核心态。

## 第2章 进程管理

### 2.1 进程与线程

#### 基本概念

##### 进程

由**程序段、相关数据段和PCB**三部分构成了**进程映像（进程实体）**。

进程特征：动态性、并发性、独立性、异步性、结构性

进程的状态：运行态、就绪态、阻塞态（等待态）、创建态、结束态

在撤销父进程时，必须同时撤销其所有的子进程，创建进程时需要为其分配唯一的进程标志号，并申请一个空白的PCB（PCB是有限的，意味着进程总数也是有限的）。若PCB申请失败，则创建失败。

注意：**“调度”和“切换”的区别。**调度是决定资源分配给哪个进程的行为，是一种决策行为；切换是指实际分配行为，是执行行为。一般说来，先有资源的调度，然后才有进程的切换。

<font color="limegreen">**表2.1 PCB通常包含的内容**</font>

|   进程描述信息    | 进程控制和管理信息 | 资源分配清单 | 处理机相关信息 |
| :---------------: | :----------------: | :----------: | :------------: |
| 进程标识符（PID） |    进程当前状态    |  代码段指针  |  通用寄存器值  |
| 用户标识符（UID） |     进程优先级     |  数据段指针  |  地址寄存器值  |
|                   |  代码运行入口地址  |  堆栈段指针  |  控制寄存器值  |
|                   |   程序的外存地址   |  文件描述符  |  标志寄存器值  |
|                   |    进入内存事件    |     键盘     |     状态字     |
|                   |   处理机占用时间   |     鼠标     |                |
|                   |     信号量使用     |              |                |

目前常用的PCB组织方式有**链接方式**和**索引方式**两种。

程序可被多个进程共享，即多个进程可以运行同一个程序。

**进程通信**：PV操作是低级通信方式，高级通信方式是指以较高效率传输大量数据的通信方式，有以下三类；

1、共享存储：一块可直接访问的共享空间。低级方式的共享是基于数据结构的共享；高级方式的共享则是基于存储区的共享。

2、消息传递：交换以格式化的消息为单位；（1）直接通信方式，将消息挂在接收进程的消息缓冲队列上；（2）间接通信，将消息发送到中间实体（一般为信箱），故又称为信箱通信方式。在计算机网络中对应电子邮件系统。

3、管道通信：管道是半双工通信的，所以需要定义两个管道。**只有写满才读，读空才写**。

##### 线程

线程组成：线程ID、程序计数器、寄存器集合、堆栈。在一个进程中的多个线程共享进程的地址空间，线程间可以直接读写进程数据段（如全局变量）来进行通信。

线程分为用户级线程（ULT）和内核级线程（KLT，即内核支持的线程）。

**多线程模型**：

1）多对一：多个用户级线程映射到一个内核级线程，一个线程被阻塞整个进程被阻塞，多线程不能并行运行在处理机上。

2）一对一：创建线程开销大，影响应用程序性能。

3）多对多：n个用户级进程映射到m个内核级线程，m<=n，集两者之所长。

#### 例题

5. 下面的叙述中，正确的是（~~C~~）A

   A、进程获得处理器运行是通过调度得到的

   B、优先级是进程调度的重要依据，一旦确定不能改动

   C、在单处理器系统中，任何时刻都只有一个进程处于运行态

   D、进程申请处理器而得不到满足时，其状态变为阻塞态

   `调度是策略，切换是具体的执行动作。死锁时无运行的进程。`

15. 下面的说法中，正确的是（~~D~~）C

    C、不管系统中是否有线程，进程都是拥有资源的独立单位

    D、在引入线程的系统中，进程仍然是资源调度和分派的基本单位

    `引入线程后，进程仍然是资源分配的单位。线程是处理器调度和分派的单位，线程本身不具有资源，它可以共享所属进程全部的资源。同时，假如有一个内核进程，它映射到用户级后有多个线程，那么这些线程之间的切换不需要在内核级切换进程，也就不需要内核的支持。`

18. 下列几种关于进程的叙述，（~~C~~）A最不符合操作系统对进程的理解

    A、进程是在多程序环境中的完整程序

    C、线程是一种特殊的进程

    `程序是静态的，进程是动态的。`

20. 若一个进程实体由PCB、共享正文段、数据堆段和数据栈段组成，请指出下列C语言程序中的内容及相关数据结构各位于哪一段中。

    I、全局赋值变量（B）				II、未赋值的局部变量（D）

    III、函数调用实参传递值（D）				IV、用malloc()要求动态分配的存储区（C）

    V、常量值（如1995、“string”）（B）				VI、进程的优先级（A）

    A、PCB				B、正文段				C、堆段				D、栈段

    

22. 系统动态DLL库中的系统线程，被不同的进程所调用，它们是（~~C~~）B的线程

    A、不同				B、相同				C、可能不同，可能相同				D、不能被调用

    `程序代码经过多次创建可对应不同的进程，而同一个系统的进程（或线程）可以由系统调用的方法被不同的进程（或线程）多次使用。`

35. 在以下描述中，（C）并不是多线程系统的特长

    A 、利用线程并行地执行矩阵乘法运算

    B、Web服务器利用线程响应HTTP请求

    C、键盘驱动程序为每个正在运行的应用配备一个线程，用以响应该应用的键盘输入

    D、基于GUI的调试程序用不同的线程分别处理用户输入、计算和跟踪等操作

    `键盘只有一个，且输入速度慢，可以使用一个线程来处理整个系统的键盘输入。`

53. 【2019统考真题】下列关于线程的描述中，错误的是（~~D~~）B

    A、内核级线程的调度由操作系统完成

    B、操作系统为每个用户级线程建立一个线程控制块

    C、用户级线程间的切换比内核级线程间的切换效率高

    D、用户级线程可以在不支持内核级线程的操作系统上实现

    `“操作系统为每个用户线程建立一个线程控制块”属于一对一模型。用户级线程的管理工作可以只在用户空间中进行，因此可以在不支持内核级线程的操作系统给上实现。`

### 2.2 处理机调度

#### 基本概念

**调度的层次**：

1）作业调度（高级调度）：内存与辅存之间的调度。对于每个作业只调入一次、调出一次。

2）中级调度（内存调度）：为了提高内存利用率和系统吞吐量，将那些暂时不能运行的进程调至外存等待，把此时的进程状态称为挂起态。

3）进程调度（低级调度）：选择进程，将处理机分配给它。

**不能进行进程的调度与切换的情况**：

1）在处理中断的过程中。

2）进程在操作系统内核程序临界区中。

3）其他需要完全屏蔽中断的原子操作过程中，在原子过程中，连中断都要屏蔽。

周转时间：从作业提交到作业完成所经历的时间

$$
\begin{aligned}
周转时间&=作业完成时间-作业提交时间 \\
平均周转时间&=\frac{(作业1的周转时间+\dots+作业n的周转时间)}{n} \\
带权周转时间&=\frac{作业周转时间}{作业实际运行时间} \\
平均带权周转时间&=\frac{作业1的带权周转时间+\dots+作业n的带权周转时间}{n} \\
\end{aligned}
$$

等待时间：进程处于等待处理机状态的时间之和

响应时间：从用户提交请求到系统首次产生响应所用的时间

##### 典型调度算法

1、**先来先服务（FCFS）**：不可剥夺算法。对长作业比较有利，对短作业不利；有利于CPU繁忙型作业，而不利于I/O繁忙型作业。

2、**短作业优先（SJF）**：对长作业不利，有可能出现**“饥饿”现象**。平均等待时间、平均周转时间最少。

3、**优先级调度算法**（优先权调度算法）：非剥夺式|剥夺式、静态优先级|动态优先级。一般系统优先级设置可参考：（1）系统进程>用户进程，（2）交互型进程>非交互型进程，（3）I/O型进程>计算型进程。<u>**适合实时操作系统**</u>。

4、**高响应比优先**：主要用于作业调度。
$$
\begin{aligned}
响应比R_p=\frac{等待时间+要求服务时间}{要求服务时间} \\
\end{aligned}
$$
1）作业等待时间相同时，有利于短作业；

2）要求服务时间相同时，先来先服务；

3）对于长作业克服了饥饿状态。

5、**时间片轮转**：适用于分时系统，先来先服务原则。时间片过大退化为先来先服务，时间片过小处理机切换进程开销过大。

6、**多级反馈队列调度**：不必事先估计进程的执行时间。

1）设置多个就绪队列，各队列优先级逐次降低

2）在优先级越高的队列中，每个进程的运行时间片越小。第i+1级队列的时间片比第i级的长1倍。

3） 首先进入第1级队列末尾，每个队列按照先来先服务原则调度，如果在时间片内未完成，则进入第2级队列末尾，之后在时间片内如果未完成，则依次降低到第n级队列后，在第n级队列采用时间片轮转的方式运行。

4）仅当第1~(i-1)级队列均为空，才调度第i级队列运行。如果这时有进程进入更高优先级队列，则新进程**抢占**处理机，**当前进程放回第i级队列末尾**。

后三种调度算法轮流占用CPU，适合**分时操作系统**。

#### 例题

1. 时间片轮转调度算法是为了（~~B~~）A

   A、多个用户能及时干预系统				B、使系统变得高效

   `cao`

22. 【2016统考真题】